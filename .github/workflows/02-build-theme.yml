# .github/workflows/02-build-theme.yml
name: Build Theme

on:
  workflow_dispatch:
    inputs:
      config_artifact:
        description: 'Configuration artifact name'
        required: true
        type: string
  workflow_call:
    inputs:
      config_artifact:
        required: true
        type: string
    outputs:
      theme_artifact:
        description: "Built theme artifact"
        value: theme-${{ jobs.build.outputs.slug }}-${{ github.run_id }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      slug: ${{ steps.config.outputs.slug }}
      artifact_id: ${{ steps.upload.outputs['artifact-id'] }}
    steps:
      - uses: actions/checkout@v4

      - name: Download configuration
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.config_artifact }}

      - name: Extract configuration values
        id: config
        run: |
          echo "slug=$(jq -r '.slug // "business-site"' website.json)"        >> $GITHUB_OUTPUT
          echo "name=$(jq -r '.name // "Your Business"' website.json)"        >> $GITHUB_OUTPUT
          echo "tagline=$(jq -r '.tagline // "Professional services"' website.json)" >> $GITHUB_OUTPUT
          echo "brand=$(jq -r '.brand.colors.primary // "#2563eb"' website.json)"   >> $GITHUB_OUTPUT
          echo "accent=$(jq -r '.brand.colors.accent  // "#1d4ed8"' website.json)"   >> $GITHUB_OUTPUT

      - name: Generate theme files
        env:
          SLUG:    ${{ steps.config.outputs.slug }}
          NAME:    ${{ steps.config.outputs.name }}
          TAGLINE: ${{ steps.config.outputs.tagline }}
          BRAND:   ${{ steps.config.outputs.brand }}
          ACCENT:  ${{ steps.config.outputs.accent }}
        run: |
          set -e
          THEME_DIR="${SLUG}-child"
          mkdir -p "$THEME_DIR/assets/css" "$THEME_DIR/assets/js" "$THEME_DIR/assets/img" "$THEME_DIR/dist" "$THEME_DIR/patterns"

          # style.css
          cat > "$THEME_DIR/style.css" << EOF
          /*
          Theme Name: ${NAME}
          Description: AI-generated professional website built with SiteFuse
          Template: sitefuse-base
          Text Domain: ${SLUG}-child
          Version: 1.2.0
          */
          EOF

          # functions.php
          cat > "$THEME_DIR/functions.php" << 'EOF'
          <?php
          add_action('wp_enqueue_scripts', function () {
              $parent_css = get_template_directory_uri() . '/dist/tailwind.css';
              wp_enqueue_style('sitefuse-parent', $parent_css, [], null);
              $child_css_path = get_stylesheet_directory() . '/dist/tailwind.css';
              $child_css_ver = file_exists($child_css_path) ? filemtime($child_css_path) : '1.0.0';
              wp_enqueue_style('sitefuse-child', get_stylesheet_directory_uri() . '/dist/tailwind.css', ['sitefuse-parent'], $child_css_ver);
              wp_enqueue_script('sitefuse-theme', get_stylesheet_directory_uri() . '/assets/js/theme.js', [], $child_css_ver, true);
          });
          add_action('after_setup_theme', function () {
              add_theme_support('post-thumbnails');
              add_theme_support('custom-logo');
              add_theme_support('title-tag');
              register_nav_menus(['primary' => 'Primary Navigation', 'footer' => 'Footer Navigation']);
          });
          function get_theme_image($image_name, $fallback_url = '') {
              $theme_image = get_stylesheet_directory_uri() . '/assets/img/' . $image_name;
              $theme_path = get_stylesheet_directory() . '/assets/img/' . $image_name;
              if (file_exists($theme_path)) return $theme_image;
              return $fallback_url ?: 'https://images.unsplash.com/photo-1497366216548-37526070297c?w=800&h=600&fit=crop';
          }
          EOF

          # Enhanced CSS with all block type support
          cat > "$THEME_DIR/assets/css/tailwind.css" << EOF
          @tailwind base;
          @tailwind components;
          @tailwind utilities;

          @layer base {
            :root {
              --color-brand-primary: ${BRAND};
              --color-brand-secondary: #3b82f6;
              --color-brand-accent: ${ACCENT};
              --color-cream: #fefaf6;
              --color-dark: #1f2937;
              --color-text: #111827;
              --color-bg: #f8fafc;
            }
            
            html { 
              scroll-behavior: smooth; 
            }
            
            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
              line-height: 1.7;
              color: var(--color-text);
              background-color: var(--color-bg);
              -webkit-font-smoothing: antialiased;
              -moz-osx-font-smoothing: grayscale;
            }

            h1, h2, h3, h4, h5, h6 {
              font-weight: 700;
              line-height: 1.2;
              color: var(--color-dark);
            }

            /* Dynamic color classes */
            .text-primary { color: var(--color-brand-primary) !important; }
            .bg-primary { background-color: var(--color-brand-primary) !important; }
            .border-primary { border-color: var(--color-brand-primary) !important; }
            .ring-primary { --tw-ring-color: var(--color-brand-primary) !important; }
          }

          @layer components {
            .container { 
              width: 100%; 
              margin: 0 auto; 
              padding: 0 1rem; 
              max-width: 80rem; 
            }
            
            @media (min-width: 640px) {
              .container { padding: 0 1.5rem; }
            }
            
            @media (min-width: 1024px) {
              .container { padding: 0 2rem; }
            }

            /* Button Components */
            .btn { 
              @apply inline-flex items-center justify-center px-6 py-3 text-base font-semibold rounded-xl transition-all duration-300 text-center no-underline cursor-pointer border-0;
              box-shadow: 0 4px 14px 0 rgba(0, 0, 0, 0.1);
            }
            
            .btn:hover {
              transform: translateY(-1px);
              box-shadow: 0 8px 25px 0 rgba(0, 0, 0, 0.15);
            }
            
            .btn-primary { 
              background: linear-gradient(135deg, var(--color-brand-primary) 0%, var(--color-brand-accent) 100%);
              color: white;
            }
            
            .btn-primary:hover {
              background: linear-gradient(135deg, var(--color-brand-accent) 0%, var(--color-brand-primary) 100%);
              color: white;
            }
            
            .btn-secondary { 
              background: white;
              color: var(--color-brand-primary);
              border: 2px solid var(--color-brand-primary);
            }
            
            .btn-secondary:hover {
              background: var(--color-brand-primary);
              color: white;
            }

            /* Typography */
            .section-title { 
              @apply text-4xl md:text-5xl font-bold text-center mb-4;
              color: var(--color-dark);
              line-height: 1.1;
            }

            .hero-section { 
              @apply relative min-h-screen flex items-center justify-center overflow-hidden;
            }

            .hero-section .container {
              @apply relative z-20;
            }

            /* Prose styling for content areas */
            .prose {
              @apply text-gray-600 leading-relaxed;
            }
            
            .prose h1, .prose h2, .prose h3, .prose h4 {
              @apply text-gray-900 font-bold mb-4;
            }
            
            .prose h1 { @apply text-3xl; }
            .prose h2 { @apply text-2xl; }
            .prose h3 { @apply text-xl; }
            
            .prose p {
              @apply mb-4;
            }
            
            .prose ul, .prose ol {
              @apply ml-6 mb-4;
            }
            
            .prose li {
              @apply mb-2;
            }
            
            .prose-lg {
              @apply text-lg leading-relaxed;
            }
            
            .prose-xl {
              @apply text-xl leading-relaxed;
            }

            /* Card Components */
            .card {
              @apply bg-white rounded-xl shadow-lg p-6 transition-all duration-300;
            }
            
            .card:hover {
              @apply shadow-xl;
              transform: translateY(-2px);
            }
          }

          /* Mobile-first responsive utilities */
          @media (max-width: 640px) {
            .section-title { @apply text-3xl; }
            .hero-section { @apply min-h-[70vh]; }
            .container { @apply px-4; }
          }
          EOF

          # include website.json for deploy
          cp website.json "$THEME_DIR/"

      - name: Build Tailwind CSS
        env:
          SLUG: ${{ steps.config.outputs.slug }}
        run: |
          set -e
          curl -sL https://github.com/tailwindlabs/tailwindcss/releases/download/v3.4.1/tailwindcss-linux-x64 -o tailwindcss
          chmod +x tailwindcss
          THEME_DIR="${SLUG}-child"
          cat > "$THEME_DIR/tailwind.config.js" << 'EOF'
          module.exports = {
            content: ['./**/*.php'],
            safelist: [
              // Core components
              'container','btn','btn-primary','btn-secondary','section-title','hero-section',
              'card','prose','prose-lg','prose-xl',
              
              // Layout & spacing
              'py-16','py-20','py-24','px-4','px-6','px-8','mb-4','mb-6','mb-8','mb-16',
              'mt-4','mt-6','mt-8','space-y-2','space-y-4','space-y-6','space-y-8',
              
              // Grid & flex
              'grid','gap-4','gap-6','gap-8','gap-12','flex','items-center','items-start',
              'justify-between','justify-center','grid-cols-1','grid-cols-2','grid-cols-3','grid-cols-4',
              'md:grid-cols-2','lg:grid-cols-3','lg:grid-cols-4','auto-cols-fr',
              
              // Typography
              'text-sm','text-base','text-lg','text-xl','text-2xl','text-3xl','text-4xl','text-5xl','text-6xl',
              'font-medium','font-semibold','font-bold','leading-relaxed','text-center','text-left',
              'italic','tracking-wide',
              
              // Colors
              'text-white','text-gray-600','text-gray-700','text-gray-900','text-green-500','text-green-600',
              'text-primary','text-yellow-400','bg-white','bg-gray-50','bg-gray-100','bg-gray-900',
              'bg-primary','bg-secondary','bg-green-100',
              
              // Effects
              'shadow','shadow-lg','shadow-xl','rounded-lg','rounded-xl','rounded-2xl','rounded-full',
              'transition-all','duration-200','duration-300','hover:shadow-xl','group-hover:opacity-100',
              'opacity-0','opacity-90','opacity-100','backdrop-blur-md',
              
              // Positioning
              'relative','absolute','inset-0','top-0','z-10','z-20','z-40','sticky',
              'min-h-screen','min-h-[70vh]','aspect-square','overflow-hidden',
              
              // Responsive
              'max-w-none','max-w-2xl','max-w-3xl','max-w-4xl','max-w-5xl','mx-auto',
              'w-full','w-8','w-16','w-24','h-8','h-16','h-20','h-24','flex-1','flex-shrink-0',
              
              // Borders
              'border','border-b','border-2','border-gray-200','border-transparent',
              'ring-2','ring-primary',
              
              // Special utilities
              'antialiased','whitespace-nowrap','cursor-pointer','transform','hover:transform',
              'hover:scale-105','group','last:border-b-0'
            ],
            theme: { 
              extend: {
                colors: {
                  'primary': 'var(--color-brand-primary)',
                  'secondary': 'var(--color-brand-secondary)',
                  'accent': 'var(--color-brand-accent)',
                },
                fontFamily: {
                  'heading': ['var(--font-heading)', 'system-ui', 'sans-serif'],
                  'body': ['var(--font-body)', 'system-ui', 'sans-serif'],
                }
              }
            },
            plugins: []
          }
          EOF
          ./tailwindcss --config "$THEME_DIR/tailwind.config.js" --input "$THEME_DIR/assets/css/tailwind.css" --output "$THEME_DIR/dist/tailwind.css" --minify

      - name: Generate PHP templates (front-page uses shortcode)
        env:
          SLUG: ${{ steps.config.outputs.slug }}
        run: |
          set -e
          THEME_DIR="${SLUG}-child"

          # front-page.php delegates to shortcode
          cat > "$THEME_DIR/front-page.php" << 'EOF'
          <?php get_header(); ?>
          <main id="main" class="site-main">
            <?php echo do_shortcode('[sitefuse_home]'); ?>
          </main>
          <?php get_footer(); ?>
          EOF

          # header.php
          cat > "$THEME_DIR/header.php" << 'EOF'
          <!DOCTYPE html>
          <html <?php language_attributes(); ?>>
          <head>
            <meta charset="<?php bloginfo('charset'); ?>">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <?php wp_head(); ?>
          </head>
          <body <?php body_class('font-sans antialiased'); ?>>
            <header class="sticky top-0 z-40 bg-white/95 backdrop-blur-md border-b">
              <div class="container">
                <div class="flex items-center justify-between h-20">
                  <a href="<?php echo esc_url(home_url('/')); ?>">
                    <span class="text-2xl font-bold" style="color: var(--color-brand-primary);"><?php bloginfo('name'); ?></span>
                  </a>
                  <nav class="hidden lg:flex items-center space-x-4">
                    <?php wp_nav_menu(['theme_location'=>'primary','container'=>false]); ?>
                  </nav>
                </div>
              </div>
            </header>
          EOF

          # footer.php
          cat > "$THEME_DIR/footer.php" << 'EOF'
          <footer class="bg-gray-900 text-gray-300 mt-20">
            <div class="container py-16">
              <div class="text-center">
                <h3 class="text-2xl font-bold mb-4"><?php bloginfo('name'); ?></h3>
                <p class="mb-6"><?php echo esc_html(get_bloginfo('description')); ?></p>
                <p class="text-sm">Â© <?php echo date('Y'); ?> <?php bloginfo('name'); ?>. All rights reserved.</p>
              </div>
            </div>
            <?php wp_footer(); ?>
          </body>
          </html>
          EOF

          # index.php
          cat > "$THEME_DIR/index.php" << 'EOF'
          <?php get_header(); ?>
          <main id="main" class="container py-20">
            <?php if (have_posts()) : while (have_posts()) : the_post(); the_content(); endwhile; endif; ?>
          </main>
          <?php get_footer(); ?>
          EOF

      - name: Upload built theme
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: theme-${{ steps.config.outputs.slug }}-${{ github.run_id }}
          path: ${{ steps.config.outputs.slug }}-child/
          retention-days: 1
