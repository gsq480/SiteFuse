# .github/workflows/03-deploy.yml
name: Deploy Theme

on:
  workflow_dispatch:
    inputs:
      theme_artifact:
        description: "Theme artifact name (theme-<slug>-<run_id>)"
        required: true
        type: string
      slug:
        description: "Theme slug"
        required: true
        type: string
      name:
        description: "Site name"
        required: true
        type: string
      tagline:
        description: "Site tagline"
        required: true
        type: string
  workflow_call:
    inputs:
      theme_artifact:
        required: true
        type: string
      slug:
        required: true
        type: string
      name:
        required: true
        type: string
      tagline:
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      CLOUDWAYS_HOST: ${{ secrets.CLOUDWAYS_HOST }}
      CLOUDWAYS_USER: ${{ secrets.CLOUDWAYS_USER }}
      CLOUDWAYS_KEY:  ${{ secrets.CLOUDWAYS_KEY }}
      APP_PATH:       ${{ secrets.APP_PATH }}
    steps:
      - uses: actions/checkout@v4

      - name: Download built theme
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.theme_artifact }}
          path: theme-files/

      - name: Setup SSH
        run: |
          set -e
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "$CLOUDWAYS_KEY" > ~/.ssh/id_rsa_cloudways
          chmod 600 ~/.ssh/id_rsa_cloudways
          ssh-keyscan -H "$CLOUDWAYS_HOST" >> ~/.ssh/known_hosts

      - name: Sanity check remote APP_PATH
        run: |
          set -e
          ssh -i ~/.ssh/id_rsa_cloudways -o StrictHostKeyChecking=no \
            "$CLOUDWAYS_USER@$CLOUDWAYS_HOST" \
            "test -d '$APP_PATH' || { echo 'Remote APP_PATH does not exist: $APP_PATH'; exit 1; }"

      - name: Deploy child theme + website.json
        env:
          SLUG: ${{ inputs.slug }}
        run: |
          set -e
          THEME_DEST="$APP_PATH/wp-content/themes/${SLUG}-child"
          ssh -i ~/.ssh/id_rsa_cloudways -o StrictHostKeyChecking=no "$CLOUDWAYS_USER@$CLOUDWAYS_HOST" "mkdir -p '$THEME_DEST'"

          rsync -avz --delete -e 'ssh -i ~/.ssh/id_rsa_cloudways -o StrictHostKeyChecking=no' \
            "theme-files/" "$CLOUDWAYS_USER@$CLOUDWAYS_HOST:$THEME_DEST/"

          # also copy website.json into app root for mu-plugin access
          if [ -f "theme-files/website.json" ]; then
            rsync -avz -e 'ssh -i ~/.ssh/id_rsa_cloudways -o StrictHostKeyChecking=no' \
              "theme-files/website.json" "$CLOUDWAYS_USER@$CLOUDWAYS_HOST:$APP_PATH/"
          fi

      - name: Configure WordPress
        env:
          SLUG:    ${{ inputs.slug }}
          NAME:    ${{ inputs.name }}
          TAGLINE: ${{ inputs.tagline }}
        run: |
          set -e
          ssh -i ~/.ssh/id_rsa_cloudways -o StrictHostKeyChecking=no "$CLOUDWAYS_USER@$CLOUDWAYS_HOST" \
            "cd '$APP_PATH' && \
             wp option update blogname       '$NAME'    --allow-root && \
             wp option update blogdescription '$TAGLINE' --allow-root && \
             wp theme activate '${SLUG}-child' --allow-root && \
             wp rewrite flush --allow-root"

      - name: Install mu-plugin for home rendering
        run: |
          set -e
          ssh -i ~/.ssh/id_rsa_cloudways -o StrictHostKeyChecking=no \
            "$CLOUDWAYS_USER@$CLOUDWAYS_HOST" \
            "mkdir -p '$APP_PATH/wp-content/mu-plugins' && cat > '$APP_PATH/wp-content/mu-plugins/sitefuse-home.php'" <<'PHP'
          <?php
          /*
           * Plugin Name: SiteFuse Home Renderer
           * Description: Shortcode [sitefuse_home] renders hero, blocks and custom sections from website.json
           */
          add_shortcode('sitefuse_home', function () {
              $p = ABSPATH . 'website.json';
              $cfg = is_readable($p) ? json_decode(file_get_contents($p), true) ?: [] : [];
              ob_start();

              // Prefer new hero schema
              if (!empty($cfg['hero'])) {
                $h = $cfg['hero'];
                echo '<section class="hero-section relative"><div class="relative z-10 container text-center text-white py-24">';
                if (!empty($h['title'])) echo '<h1 class="text-4xl font-bold mb-6">'.esc_html($h['title']).'</h1>';
                if (!empty($h['subtitle'])) echo '<p class="text-xl mb-8">'.esc_html($h['subtitle']).'</p>';
                if (!empty($h['cta']['label'])) echo '<a class="btn btn-primary" href="'.esc_url($h['cta']['href']).'">'.esc_html($h['cta']['label']).'</a>';
                echo '</div></section>';
              }

              // Custom raw HTML sections
              if (!empty($cfg['customSections'])) {
                foreach ($cfg['customSections'] as $i => $s) {
                  if (!empty($s['html'])) {
                    echo "\n<!-- ai-section-$i -->\n";
                    echo wp_kses_post($s['html']);
                  }
                }
              }

              // Rich block rendering
              if (!empty($cfg['pages'])) {
                foreach ($cfg['pages'] as $p) {
                  if ($p['slug'] === 'home' && !empty($p['blocks'])) {
                    if (function_exists('sitefuse_render_blocks')) {
                      sitefuse_render_blocks($p['blocks']);
                    }
                  }
                }
              }
              return ob_get_clean();
          });
          PHP

      - name: Report deployment
        run: |
          echo "‚úÖ Deployment completed"
          echo "üì± Site: ${{ inputs.name }}"
          echo "üîß Theme: ${{ inputs.slug }}-child"
          echo "üåê Visit via your Cloudways domain"
