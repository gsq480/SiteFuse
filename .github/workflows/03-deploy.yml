# .github/workflows/03-deploy.yml
name: Deploy Theme

on:
  workflow_dispatch:
    inputs:
      theme_artifact:
        description: 'Theme artifact name (theme-<slug>-<run_id>)'
        required: true
        type: string
      slug:
        description: 'Theme slug'
        required: true
        type: string
      name:
        description: 'Site name'
        required: true
        type: string
      tagline:
        description: 'Site tagline'
        required: true
        type: string
  workflow_call:
    inputs:
      theme_artifact: { required: true, type: string }
      slug:           { required: true, type: string }
      name:           { required: true, type: string }
      tagline:        { required: true, type: string }

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      CLOUDWAYS_HOST: ${{ secrets.CLOUDWAYS_HOST }}
      CLOUDWAYS_USER: ${{ secrets.CLOUDWAYS_USER }}
      CLOUDWAYS_KEY:  ${{ secrets.CLOUDWAYS_KEY }}
      APP_PATH:       ${{ secrets.APP_PATH }}
    steps:
      - uses: actions/checkout@v4

      - name: Download built theme
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.theme_artifact }}
          path: theme-files/

      - name: Setup SSH
        run: |
          set -e
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "$CLOUDWAYS_KEY" > ~/.ssh/id_rsa_cloudways
          chmod 600 ~/.ssh/id_rsa_cloudways
          ssh-keyscan -H "$CLOUDWAYS_HOST" >> ~/.ssh/known_hosts

      - name: Sanity check remote APP_PATH
        run: |
          set -e
          ssh -i ~/.ssh/id_rsa_cloudways -o StrictHostKeyChecking=no \
            "$CLOUDWAYS_USER@$CLOUDWAYS_HOST" \
            "APP_PATH='${APP_PATH}' bash -s" <<'EOF'
          set -euo pipefail
          : "${APP_PATH:?APP_PATH is not set on remote}"
          if [ ! -d "$APP_PATH" ]; then
            echo "Remote APP_PATH does not exist: $APP_PATH" >&2
            exit 1
          fi
          echo "OK: APP_PATH is $APP_PATH"
          EOF

      - name: Deploy child theme + website.json
        env:
          SLUG: ${{ inputs.slug }}
        run: |
          set -e
          THEME_DEST="$APP_PATH/wp-content/themes/${SLUG}-child"
          ssh -i ~/.ssh/id_rsa_cloudways -o StrictHostKeyChecking=no "$CLOUDWAYS_USER@$CLOUDWAYS_HOST" "mkdir -p '$THEME_DEST'"
          rsync -avz --delete -e 'ssh -i ~/.ssh/id_rsa_cloudways -o StrictHostKeyChecking=no' \
            "theme-files/" "$CLOUDWAYS_USER@$CLOUDWAYS_HOST:$THEME_DEST/"
          if [ -f "theme-files/website.json" ]; then
            rsync -avz -e 'ssh -i ~/.ssh/id_rsa_cloudways -o StrictHostKeyChecking=no' \
              "theme-files/website.json" "$CLOUDWAYS_USER@$CLOUDWAYS_HOST:$APP_PATH/"
          fi

      - name: Install/Update enhanced mu-plugin (supports all block types)
        run: |
          set -e
          ssh -i ~/.ssh/id_rsa_cloudways -o StrictHostKeyChecking=no \
            "$CLOUDWAYS_USER@$CLOUDWAYS_HOST" \
            "APP_PATH='${APP_PATH}' bash -s" <<'EOF'
          set -euo pipefail
          : "${APP_PATH:?APP_PATH is not set on remote}"
          MU_DIR="$APP_PATH/wp-content/mu-plugins"
          mkdir -p "$MU_DIR"
          cat > "$MU_DIR/sitefuse-home.php" <<'PHP'
          <?php
          /*
           * Plugin Name: SiteFuse Enhanced Home Renderer
           * Description: Shortcode [sitefuse_home] renders dynamic layouts from website.json
           * Version: 2.0.0
           */
          add_shortcode('sitefuse_home', function () {
              $p = ABSPATH . 'website.json';
              $cfg = is_readable($p) ? json_decode(file_get_contents($p), true) ?: [] : [];

              // Back-compat shims
              if (!isset($cfg['hero']) && isset($cfg['heroSection'])) {
                  $cfg['hero'] = [
                      'title'    => get_bloginfo('name'),
                      'subtitle' => get_bloginfo('description'),
                      'cta'      => ['label' => 'Get Started', 'href' => '#contact'],
                      'image'    => $cfg['heroSection']['heroImage'] ?? '',
                      'overlay'  => 0.35,
                  ];
              }
              if (!isset($cfg['pages']) && isset($cfg['customSections'])) {
                  $blocks = [];
                  foreach ($cfg['customSections'] as $s) {
                      $blocks[] = ['type' => 'html', 'html' => $s['html'] ?? ''];
                  }
                  $cfg['pages'] = [[ 'slug'=>'home','title'=>'Home','layout'=>'landing','blocks'=>$blocks ]];
              }

              $esc = fn($s) => esc_html($s ?? '');
              $img = function ($url, $alt = '') {
                  if (!$url) return '';
                  return '<img src="'.esc_url($url).'" alt="'.esc_attr($alt).'" class="w-full h-full object-cover" />';
              };

              // Pick home page
              $home = ['blocks' => []];
              if (!empty($cfg['pages']) && is_array($cfg['pages'])) {
                  foreach ($cfg['pages'] as $page) {
                      if (($page['slug'] ?? '') === 'home') { $home = $page; break; }
                  }
                  if (empty($home['blocks'])) { $home = $cfg['pages'][0]; }
              }

              ob_start();

              // Enhanced block renderers
              $render = [
                  'hero' => function($b) use ($cfg, $esc, $img) {
                      $hero = $cfg['hero'] ?? [];
                      $overlay = isset($hero['overlay']) ? floatval($hero['overlay']) : 0.35;
                      ?>
                      <section class="hero-section relative min-h-screen flex items-center">
                        <div class="absolute inset-0">
                          <?php echo $img($hero['image'] ?? '', get_bloginfo('name')); ?>
                          <div class="absolute inset-0" style="background:rgba(0,0,0,<?php echo esc_attr($overlay); ?>)"></div>
                        </div>
                        <div class="relative z-10 container text-center text-white py-24">
                          <h1 class="text-6xl font-bold mb-6"><?php echo $esc($hero['title'] ?? get_bloginfo('name')); ?></h1>
                          <p class="text-xl mb-10 opacity-90 max-w-3xl mx-auto"><?php echo $esc($hero['subtitle'] ?? get_bloginfo('description')); ?></p>
                          <?php if (!empty($hero['cta']['label'])): ?>
                            <a class="btn btn-primary text-lg px-8 py-4" href="<?php echo esc_url($hero['cta']['href'] ?? '#contact'); ?>">
                              <?php echo $esc($hero['cta']['label']); ?>
                            </a>
                          <?php endif; ?>
                        </div>
                      </section>
                      <?php
                  },

                  'features' => function($b) use ($esc) {
                      $items = $b['items'] ?? [];
                      $cols  = max(2, min(4, intval($b['columns'] ?? 3)));
                      ?>
                      <section class="py-20 bg-white">
                        <div class="container">
                          <?php if (!empty($b['title'])): ?>
                            <h2 class="section-title text-center mb-16"><?php echo $esc($b['title']); ?></h2>
                          <?php endif; ?>
                          <div class="grid gap-8" style="grid-template-columns:repeat(<?php echo $cols; ?>,minmax(0,1fr))">
                            <?php foreach ($items as $item): ?>
                              <div class="text-center p-6">
                                <?php if (!empty($item['icon'])): ?>
                                  <div class="mb-4 text-4xl"><?php echo $esc($item['icon']); ?></div>
                                <?php endif; ?>
                                <h3 class="text-xl font-bold mb-4"><?php echo $esc($item['title'] ?? 'Feature'); ?></h3>
                                <p class="text-gray-600 leading-relaxed"><?php echo $esc($item['text'] ?? ''); ?></p>
                              </div>
                            <?php endforeach; ?>
                          </div>
                        </div>
                      </section>
                      <?php
                  },

                  'services' => function($b) use ($esc) {
                      $items = $b['items'] ?? [];
                      ?>
                      <section class="py-20 bg-gray-50">
                        <div class="container">
                          <?php if (!empty($b['title'])): ?>
                            <h2 class="section-title text-center mb-16"><?php echo $esc($b['title']); ?></h2>
                          <?php endif; ?>
                          <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
                            <?php foreach ($items as $item): ?>
                              <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300">
                                <h3 class="text-xl font-bold mb-4"><?php echo $esc($item['title'] ?? 'Service'); ?></h3>
                                <p class="text-gray-600 mb-6"><?php echo $esc($item['text'] ?? ''); ?></p>
                                <?php if (!empty($item['price'])): ?>
                                  <div class="text-2xl font-bold text-primary"><?php echo $esc($item['price']); ?></div>
                                <?php endif; ?>
                              </div>
                            <?php endforeach; ?>
                          </div>
                        </div>
                      </section>
                      <?php
                  },

                  'testimonial' => function($b) use ($esc) {
                      ?>
                      <section class="py-20 bg-primary text-white">
                        <div class="container text-center max-w-4xl mx-auto">
                          <blockquote class="text-3xl italic mb-8">"<?php echo $esc($b['quote'] ?? ''); ?>"</blockquote>
                          <div class="text-lg opacity-90">— <?php echo $esc($b['author'] ?? 'Happy Client'); ?></div>
                        </div>
                      </section>
                      <?php
                  },

                  'testimonials' => function($b) use ($esc) {
                      $items = $b['items'] ?? [];
                      ?>
                      <section class="py-20">
                        <div class="container">
                          <?php if (!empty($b['title'])): ?>
                            <h2 class="section-title text-center mb-16"><?php echo $esc($b['title']); ?></h2>
                          <?php endif; ?>
                          <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
                            <?php foreach ($items as $item): ?>
                              <div class="bg-white p-6 rounded-xl shadow">
                                <div class="text-yellow-400 mb-4">★★★★★</div>
                                <p class="mb-4 italic">"<?php echo $esc($item['quote'] ?? ''); ?>"</p>
                                <div class="font-semibold"><?php echo $esc($item['author'] ?? 'Customer'); ?></div>
                              </div>
                            <?php endforeach; ?>
                          </div>
                        </div>
                      </section>
                      <?php
                  },

                  'cta' => function($b) use ($esc) {
                      ?>
                      <section class="py-20 bg-primary text-white text-center">
                        <div class="container max-w-3xl mx-auto">
                          <?php if (!empty($b['title'])): ?>
                            <h2 class="text-4xl font-bold mb-6"><?php echo $esc($b['title']); ?></h2>
                          <?php endif; ?>
                          <p class="text-xl mb-8 opacity-90"><?php echo $esc($b['text'] ?? ''); ?></p>
                          <?php $btn = $b['button'] ?? []; if (!empty($btn['label'])): ?>
                            <a class="btn btn-secondary text-lg px-8 py-4" href="<?php echo esc_url($btn['href'] ?? '#'); ?>">
                              <?php echo $esc($btn['label']); ?>
                            </a>
                          <?php endif; ?>
                        </div>
                      </section>
                      <?php
                  },

                  'about' => function($b) use ($esc) {
                      ?>
                      <section class="py-20">
                        <div class="container max-w-4xl mx-auto">
                          <?php if (!empty($b['title'])): ?>
                            <h2 class="section-title text-center mb-16"><?php echo $esc($b['title']); ?></h2>
                          <?php endif; ?>
                          <div class="prose prose-lg max-w-none">
                            <?php echo wp_kses_post($b['content'] ?? $b['text'] ?? ''); ?>
                          </div>
                        </div>
                      </section>
                      <?php
                  },

                  'contact-form' => function($b) use ($esc) {
                      ?>
                      <section class="py-20" id="contact">
                        <div class="container max-w-3xl mx-auto">
                          <?php if (!empty($b['title'])): ?>
                            <h2 class="section-title text-center mb-16"><?php echo $esc($b['title']); ?></h2>
                          <?php endif; ?>
                          <div class="bg-white p-8 rounded-xl shadow-lg">
                            <p class="text-center mb-8 text-gray-600">
                              <?php echo $esc($b['text'] ?? 'Get in touch with us today.'); ?>
                            </p>
                            <div class="text-center">
                              <p class="mb-4">Replace with your favorite contact form plugin shortcode:</p>
                              <code class="bg-gray-100 px-3 py-1 rounded">[contact-form-7 id="1"]</code>
                            </div>
                          </div>
                        </div>
                      </section>
                      <?php
                  },

                  'pricing' => function($b) use ($esc) {
                      $plans = $b['plans'] ?? [];
                      ?>
                      <section class="py-20 bg-gray-50">
                        <div class="container">
                          <?php if (!empty($b['title'])): ?>
                            <h2 class="section-title text-center mb-16"><?php echo $esc($b['title']); ?></h2>
                          <?php endif; ?>
                          <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3 max-w-5xl mx-auto">
                            <?php foreach ($plans as $plan): ?>
                              <div class="bg-white p-8 rounded-xl shadow-lg text-center <?php echo ($plan['featured'] ?? false) ? 'ring-2 ring-primary' : ''; ?>">
                                <h3 class="text-2xl font-bold mb-4"><?php echo $esc($plan['name'] ?? 'Plan'); ?></h3>
                                <div class="text-4xl font-bold mb-6"><?php echo $esc($plan['price'] ?? '$99'); ?></div>
                                <ul class="text-left mb-8 space-y-2">
                                  <?php foreach ($plan['features'] ?? [] as $feature): ?>
                                    <li class="flex items-center">
                                      <span class="text-green-500 mr-2">✓</span>
                                      <?php echo $esc($feature); ?>
                                    </li>
                                  <?php endforeach; ?>
                                </ul>
                                <a class="btn <?php echo ($plan['featured'] ?? false) ? 'btn-primary' : 'btn-secondary'; ?> w-full" 
                                   href="<?php echo esc_url($plan['cta']['href'] ?? '#contact'); ?>">
                                  <?php echo $esc($plan['cta']['label'] ?? 'Choose Plan'); ?>
                                </a>
                              </div>
                            <?php endforeach; ?>
                          </div>
                        </div>
                      </section>
                      <?php
                  },

                  'team' => function($b) use ($esc, $img) {
                      $members = $b['members'] ?? [];
                      echo '<section class="py-20 bg-gray-50"><div class="container">';
                      if (!empty($b['title'])) echo '<h2 class="section-title text-center mb-16">'.$esc($b['title']).'</h2>';
                      echo '<div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">';
                      foreach ($members as $member) {
                          echo '<div class="bg-white p-6 rounded-xl shadow text-center">';
                          if (!empty($member['photo'])) echo '<div class="w-24 h-24 mx-auto mb-4 rounded-full overflow-hidden">'.$img($member['photo'], $member['name'] ?? 'Team member').'</div>';
                          echo '<h3 class="font-bold text-xl mb-2">'.$esc($member['name'] ?? 'Team Member').'</h3>';
                          echo '<div class="text-primary font-medium mb-3">'.$esc($member['role'] ?? '').'</div>';
                          echo '<p class="text-gray-600">'.$esc($member['bio'] ?? '').'</p></div>';
                      }
                      echo '</div></div></section>';
                  },

                  'classes' => function($b) use ($esc) {
                      $schedule = $b['schedule'] ?? [];
                      echo '<section class="py-20 bg-gray-50"><div class="container">';
                      if (!empty($b['title'])) echo '<h2 class="section-title text-center mb-16">'.$esc($b['title']).'</h2>';
                      echo '<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">';
                      foreach ($schedule as $class) {
                          echo '<div class="bg-white p-6 rounded-xl shadow">';
                          echo '<h3 class="font-bold text-xl mb-3">'.$esc($class['name'] ?? 'Class').'</h3>';
                          echo '<div class="space-y-2 text-gray-600">';
                          if (!empty($class['time'])) echo '<div><strong>Time:</strong> '.$esc($class['time']).'</div>';
                          if (!empty($class['instructor'])) echo '<div><strong>Instructor:</strong> '.$esc($class['instructor']).'</div>';
                          echo '</div>';
                          if (!empty($class['description'])) echo '<p class="mt-4 text-gray-600">'.$esc($class['description']).'</p>';
                          echo '</div>';
                      }
                      echo '</div></div></section>';
                  },

                  'two-col' => function($b) use ($esc) {
                      echo '<section class="py-20"><div class="container">';
                      if (!empty($b['title'])) echo '<h2 class="section-title text-center mb-16">'.$esc($b['title']).'</h2>';
                      echo '<div class="grid gap-12 lg:grid-cols-2 items-center">';
                      echo '<div class="prose prose-lg max-w-none">';
                      echo wp_kses_post(is_string($b['left'] ?? '') ? $b['left'] : ($b['content'] ?? ''));
                      echo '</div>';
                      echo '<div class="prose prose-lg max-w-none">';
                      echo wp_kses_post(is_string($b['right'] ?? '') ? $b['right'] : '');
                      echo '</div>';
                      echo '</div></div></section>';
                  },

                  'service-cards' => function($b) use ($esc) {
                      $items = $b['items'] ?? [];
                      echo '<section class="py-20 bg-gray-50"><div class="container">';
                      if (!empty($b['title'])) echo '<h2 class="section-title text-center mb-16">'.$esc($b['title']).'</h2>';
                      echo '<div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">';
                      foreach ($items as $item) {
                          echo '<div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300">';
                          echo '<h3 class="text-xl font-bold mb-4">'.$esc($item['title'] ?? 'Service').'</h3>';
                          echo '<p class="text-gray-600 mb-6">'.$esc($item['text'] ?? '').'</p>';
                          if (!empty($item['price'])) echo '<div class="text-2xl font-bold text-primary">'.$esc($item['price']).'</div>';
                          echo '</div>';
                      }
                      echo '</div></div></section>';
                  },

                  'html' => function($b) { 
                      echo wp_kses_post($b['html'] ?? $b['content'] ?? ''); 
                  },
              ];

              // Render all blocks from the home page
              foreach ($home['blocks'] ?? [] as $block) {
                  $type = $block['type'] ?? 'html';
                  if (isset($render[$type]) && is_callable($render[$type])) {
                      $render[$type]($block);
                  } else {
                      echo '<section class="py-20"><div class="container"><p class="text-center text-gray-500">Unknown block type: ' . esc_html($type) . '</p></div></section>';
                  }
              }

              return ob_get_clean();
          });
          PHP
          EOF

      - name: Configure WordPress (theme, pages, menu, homepage content)
        env:
          SLUG: ${{ inputs.slug }}
          NAME: ${{ inputs.name }}
          TAGLINE: ${{ inputs.tagline }}
        run: |
          set -e
          ssh -i ~/.ssh/id_rsa_cloudways -o StrictHostKeyChecking=no "$CLOUDWAYS_USER@$CLOUDWAYS_HOST" \
            "APP_PATH='${APP_PATH}' SLUG='${SLUG}' NAME='${NAME}' TAGLINE='${TAGLINE}' bash -s" <<'EOS'
          set -euo pipefail
          cd "$APP_PATH"

          wp option update blogname "$NAME" --allow-root
          wp option update blogdescription "$TAGLINE" --allow-root
          wp theme activate "${SLUG}-child" --allow-root

          HOME_ID=$(wp post list --post_type=page --name=home --field=ID --allow-root | head -1)
          if [ -z "$HOME_ID" ]; then
            HOME_ID=$(wp post create --post_type=page --post_title="Home" --post_name="home" --post_status=publish --porcelain --allow-root)
          fi
          wp post update "$HOME_ID" --post_content="[sitefuse_home]" --allow-root
          wp option update show_on_front page --allow-root
          wp option update page_on_front "$HOME_ID" --allow-root

          wp menu delete "Primary Menu" --allow-root 2>/dev/null || true
          wp menu create "Primary Menu" --allow-root
          for slug in home about services contact; do
            ID=$(wp post list --post_type=page --name="$slug" --field=ID --allow-root | head -1)
            if [ -z "$ID" ] && [ "$slug" != "home" ]; then
              TITLE=$(echo "${slug^}")
              ID=$(wp post create --post_type=page --post_title="$TITLE" --post_name="$slug" --post_status=publish --porcelain --allow-root)
            fi
            [ -n "$ID" ] && wp menu item add-post "Primary Menu" "$ID" --title="$(echo "${slug^}")" --allow-root
          done
          wp menu location assign "Primary Menu" primary --allow-root
          wp rewrite flush --allow-root
          EOS

      - name: Report deployment
        env:
          NAME: ${{ inputs.name }}
          SLUG: ${{ inputs.slug }}
        run: |
          echo "✅ Deployment completed!"
          echo "🏢 Site Name: ${NAME}"
          echo "🔧 Theme: ${SLUG}-child"
          echo "🌐 Visit via your Cloudways domain for this app"