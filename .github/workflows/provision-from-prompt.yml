name: Provision Child Theme from Prompt

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Describe your website (e.g., "Modern yoga studio with earth tones")'
        required: true
        type: string

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      CLOUDWAYS_HOST: ${{ secrets.CLOUDWAYS_HOST }}
      CLOUDWAYS_USER: ${{ secrets.CLOUDWAYS_USER }}
      CLOUDWAYS_KEY:  ${{ secrets.CLOUDWAYS_KEY }}
      APP_PATH:       ${{ secrets.APP_PATH }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: gsq480/SiteFuse
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: SSH setup
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s\n' "$CLOUDWAYS_KEY" > ~/.ssh/id_rsa_cloudways
          chmod 600 ~/.ssh/id_rsa_cloudways
          ssh-keyscan -H "$CLOUDWAYS_HOST" >> ~/.ssh/known_hosts

      - name: Turn prompt into structured JSON (OpenAI)
        id: openai
        run: |
          set -euo pipefail

          cat > /tmp/payload.json <<'JSON'
          {
            "model":"gpt-4o-mini",
            "response_format":{"type":"json_object"},
            "messages":[
              {"role":"system","content":"You extract website theming fields from a customer brief and respond in strict JSON only. Fields: slug (kebab-case, <=30 chars), name (<=40 chars), brand (hex like #7A5A45), accent (hex), hero (absolute image URL), sections (array of {title, text}). If missing, make tasteful defaults."},
              {"role":"user","content":"${{ github.event.inputs.prompt }}"}
            ]
          }
          JSON

          curl -sS https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @/tmp/payload.json \
          | jq -r '.choices[0].message.content' > brief.json

          echo "Brief JSON:" && cat brief.json | jq .

          SLUG=$(jq -r '.slug // "new-site"' brief.json | tr '[:upper:] ' '[:lower:]-' | tr -cd 'a-z0-9-_')
          SLUG=${SLUG%-}; SLUG=${SLUG#-}; [ -n "$SLUG" ] || SLUG=new-site

          NAME=$(jq -r '.name // "New Site"' brief.json)
          BRAND=$(jq -r '.brand // "#7A5A45"' brief.json)
          ACCENT=$(jq -r '.accent // "#D2B48C"' brief.json)
          HERO=$(jq -r '.hero // "https://images.unsplash.com/photo-1504754524776-8f4f37790ca0?q=80&w=1200&auto=format&fit=crop"' brief.json)

          echo "slug=$SLUG"     >> $GITHUB_OUTPUT
          echo "name=$NAME"     >> $GITHUB_OUTPUT
          echo "brand=$BRAND"   >> $GITHUB_OUTPUT
          echo "accent=$ACCENT" >> $GITHUB_OUTPUT
          echo "hero=$HERO"     >> $GITHUB_OUTPUT

      - name: Generate child theme and build CSS
        env:
          SLUG:   ${{ steps.openai.outputs.slug }}
          NAME:   ${{ steps.openai.outputs.name }}
          BRAND:  ${{ steps.openai.outputs.brand }}
          ACCENT: ${{ steps.openai.outputs.accent }}
          HERO:   ${{ steps.openai.outputs.hero }}
        run: |
          set -euo pipefail
          WORKDIR="$(mktemp -d)"; echo "Workdir: $WORKDIR"; cd "$WORKDIR"
          mkdir -p child/assets/css child/assets/img child/dist child/parts

          # style.css
          cat > child/style.css <<CSS
          /*
          Theme Name: ${NAME} Child
          Template: sitefuse-base
          Text Domain: ${SLUG}-child
          Version: 1.0.0
          */
          CSS

          # functions.php
          cat > child/functions.php <<'PHP'
          <?php
          add_action('wp_enqueue_scripts', function () {
            $parent = get_template_directory_uri() . '/dist/tailwind.css';
            wp_enqueue_style('sitefuse-parent', $parent, [], null);
            $child_path = get_stylesheet_directory() . '/dist/tailwind.css';
            $ver = file_exists($child_path) ? filemtime($child_path) : null;
            wp_enqueue_style('sitefuse-child', get_stylesheet_directory_uri() . '/dist/tailwind.css', ['sitefuse-parent'], $ver);
          });
          register_nav_menus(['primary' => 'Primary']);
          PHP

          # Tailwind source (lean)
          cat > child/assets/css/tailwind.css <<CSS
          @tailwind base;
          @tailwind components;
          @tailwind utilities;

          @layer base {
            :root {
              --color-brand: ${BRAND};
              --color-brand-600: ${BRAND}cc;
              --color-accent: ${ACCENT};
              --color-cream: #FFF7EC;
            }
          }

          @layer components {
            .container { width: 100%; margin-inline: auto; padding-inline: 1rem; max-width: 72rem; }
            .btn { display: inline-flex; align-items: center; justify-content: center; border-radius: .5rem; padding: .5rem 1.25rem; font-weight: 600; }
            .btn-primary { background-color: var(--color-brand); color: white; }
            .btn-primary:hover { opacity: .9; }
            .card { background: white; border-radius: .75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,.1); padding: 2rem; border: 1px solid rgb(241 245 249); }
            .section-title { font-size: 1.875rem; font-weight: 800; letter-spacing: -0.025em; }
            @media (min-width:768px){ .section-title{ font-size: 2.25rem; } }
            .lead { font-size: 1.125rem; color: rgb(71 85 105); }
            .nav-link:hover { text-decoration: underline; }
          }
          CSS

          # Tailwind config
          cat > child/tailwind.config.js <<'JS'
          module.exports = {
            content: ['./**/*.php'],
            theme: { extend: {} },
            plugins: [],
          }
          JS

          # Header / Footer / Front page (kept simple)
          cat > child/header.php <<'PHP'
          <!doctype html>
          <html <?php language_attributes(); ?>>
          <head>
            <meta charset="<?php bloginfo('charset'); ?>">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <?php wp_head(); ?>
          </head>
          <body <?php body_class('font-sans'); ?> style="background-color: var(--color-cream); color: rgb(15 23 42);">
          <a class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 p-2 bg-white rounded" href="#main">Skip to content</a>
          <header style="background-color: rgba(255,255,255,.9); backdrop-filter: blur(12px); border-bottom: 1px solid #e5e7eb;">
            <div class="container" style="padding: 1rem 0; display:flex; align-items:center; justify-content:space-between;">
              <a style="font-size:1.25rem; font-weight:800; letter-spacing:-.025em; color:var(--color-brand); text-decoration:none;" href="<?php echo esc_url(home_url('/')); ?>"><?php bloginfo('name'); ?></a>
              <nav class="hidden md:block">
                <?php wp_nav_menu(['theme_location'=>'primary','menu_class'=>'md:flex md:items-center md:gap-6','container'=>false,'fallback_cb'=>'__return_empty_string']); ?>
              </nav>
            </div>
          </header>
          PHP

          cat > child/footer.php <<'PHP'
          <footer style="margin-top: 4rem; background-color: rgb(15 23 42); color: rgb(226 232 240);">
            <div class="container" style="padding: 2.5rem 0; display: grid; gap: 1.5rem;">
              <div><div style="font-size:1.125rem; font-weight:600; margin-bottom:.5rem;">About</div><p style="font-size:.875rem; opacity:.8;">Welcome to <?php bloginfo('name'); ?>.</p></div>
              <div><div style="font-size:1.125rem; font-weight:600; margin-bottom:.5rem;">Contact</div><p style="font-size:.875rem; opacity:.8;">Get in touch with us today.</p></div>
            </div>
            <div style="border-top:1px solid rgb(30 41 59);">
              <div class="container" style="padding:1rem 0; font-size:.875rem; opacity:.7; display:flex; justify-content:space-between;">
                <span>Â© <?php echo date('Y'); ?> <?php bloginfo('name'); ?></span><span>Powered by WordPress</span>
              </div>
            </div>
          </footer>
          <?php wp_footer(); ?>
          </body>
          </html>
          PHP

          echo "<?php get_header(); ?>" > child/front-page.php
          cat >> child/front-page.php <<'PHP'
          <main id="main" class="container" style="padding: 2.5rem 0;">
            <section style="position:relative; overflow:hidden; border-radius:1rem; background:linear-gradient(to right, var(--color-brand), var(--color-accent)); color:white; margin-bottom:3rem;">
              <div style="padding: 4rem 3rem;">
                <div style="display:grid; gap:2rem; align-items:center;">
                  <div>
                    <h1 class="section-title" style="color:white; margin-bottom:1rem;"><?php bloginfo('description'); ?></h1>
                    <p class="lead" style="color:rgba(255,255,255,.9); margin-bottom:2rem;">Welcome to our site. Discover what we have to offer.</p>
                    <div style="display:flex; gap:1rem; flex-wrap:wrap;">
                      <a href="<?php echo esc_url(home_url('/about')); ?>" class="btn btn-primary">Learn More</a>
                      <a href="<?php echo esc_url(home_url('/contact')); ?>" class="btn" style="border:1px solid rgba(255,255,255,.6); color:white;">Contact Us</a>
                    </div>
                  </div>
                  <div style="border-radius:.75rem; overflow:hidden; box-shadow:0 20px 25px -5px rgba(0,0,0,.1);">
                    <img src="<?php echo esc_url( get_stylesheet_directory_uri() . '/assets/img/hero.jpg' ); ?>" alt="Hero" style="width:100%; height:100%; object-fit:cover;">
                  </div>
                </div>
              </div>
            </section>
          PHP

          if [ -f "$GITHUB_WORKSPACE/brief.json" ]; then
            jq -c '.sections // [] | .[]' "$GITHUB_WORKSPACE/brief.json" | while read -r row; do
              TITLE=$(jq -r '.title // empty' <<<"$row"); TEXT=$(jq -r '.text // empty' <<<"$row")
              [ -n "$TITLE" ] || continue
              cat >> child/front-page.php <<PHP
            <section class="card" style="margin-bottom: 2rem;">
              <h2 class="section-title" style="margin-bottom: 1rem;">$(printf '%s' "$TITLE" | sed "s/'/\\'/g")</h2>
              <p class="lead">$(printf '%s' "$TEXT" | sed "s/'/\\'/g")</p>
            </section>
          PHP
            done
          fi

          echo "</main>" >> child/front-page.php
          echo "<?php get_footer(); ?>" >> child/front-page.php

          # Try HERO image; if fails, multiple fallbacks then tiny PNG
          if [ -n "$HERO" ] && [ "$HERO" != "null" ]; then
            curl -fsSL "$HERO" -o child/assets/img/hero.jpg --max-time 10 || true
          fi
          if [ ! -s child/assets/img/hero.jpg ]; then
            curl -fsSL "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1200&h=800&fit=crop&crop=center" -o child/assets/img/hero.jpg --max-time 10 || \
            curl -fsSL "https://via.placeholder.com/1200x800/7A5A45/FFFFFF?text=Hero+Image" -o child/assets/img/hero.jpg --max-time 10 || \
            echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" \
              | base64 -d > child/assets/img/hero.jpg
          fi

          echo "Downloading Tailwind CSS v3 standalone CLI..."
          curl -sL https://github.com/tailwindlabs/tailwindcss/releases/download/v3.4.1/tailwindcss-linux-x64 -o tailwindcss
          chmod +x tailwindcss

          echo "Building Tailwind CSS..."
          cd child
          ../tailwindcss -i ./assets/css/tailwind.css -o ./dist/tailwind.css --minify
          rm -f tailwind.config.js
          cd ..

          # Always stage fresh output folder in workspace
          rm -rf "$GITHUB_WORKSPACE/${SLUG}-child"
          cp -r child "$GITHUB_WORKSPACE/${SLUG}-child"
          zip -qr "${SLUG}-child.zip" child/
          echo "Theme generation complete!"

      - name: Commit generated theme back to repo
        env:
          SLUG: ${{ steps.openai.outputs.slug }}
        run: |
          set -euo pipefail
          mkdir -p child-themes
          rm -rf "child-themes/${SLUG}-child"
          mv "${SLUG}-child" "child-themes/${SLUG}-child"
          git config user.name  "sitefuse-bot"
          git config user.email "bot@users.noreply.github.com"
          git add "child-themes/${SLUG}-child"
          git commit -m "chore: add generated child theme '${SLUG}-child' from prompt" || echo "No changes to commit"
          git push || echo "Push skipped"

      - name: Deploy to Cloudways via rsync
        env:
          SLUG: ${{ steps.openai.outputs.slug }}
        run: |
          set -euo pipefail
          THEME_DIR="$GITHUB_WORKSPACE/child-themes/${SLUG}-child"
          DEST="$APP_PATH/wp-content/themes/${SLUG}-child"

          if [ -d "$THEME_DIR" ]; then
            # ensure destination exists
            ssh -i ~/.ssh/id_rsa_cloudways -o StrictHostKeyChecking=no \
              "$CLOUDWAYS_USER@$CLOUDWAYS_HOST" "mkdir -p '$DEST'"

            # sync files
            rsync -avz --delete \
              -e "ssh -i ~/.ssh/id_rsa_cloudways -o StrictHostKeyChecking=no" \
              "$THEME_DIR/" \
              "$CLOUDWAYS_USER@$CLOUDWAYS_HOST:$DEST/"

            echo "â Deployed to: $DEST/"
          else
            echo "â ï¸ Theme directory not found locally, skipping deployment"
            exit 1
          fi

      - name: Cleanup old child themes on server (keep only current)
        env:
          SLUG: ${{ steps.openai.outputs.slug }}
        run: |
          set -euo pipefail
          THEMES_PATH="$APP_PATH/wp-content/themes"
          CURRENT="${SLUG}-child"

          ssh -i ~/.ssh/id_rsa_cloudways -o StrictHostKeyChecking=no "$CLOUDWAYS_USER@$CLOUDWAYS_HOST" bash -lc "
            set -euo pipefail
            cd '$THEMES_PATH'
            echo 'Before cleanup:'; ls -1 | grep -E '.*-child$' || echo '(none)'
            # delete all *-child except the current one
            for d in */ ; do
              d=\${d%/}
              if [[ \"\$d\" == *-child && \"\$d\" != \"$CURRENT\" ]]; then
                echo \"Removing stale theme: \$d\"
                rm -rf -- \"\$d\"
              fi
            done
            echo 'After cleanup:'; ls -1 | grep -E '.*-child$' || echo '(none)'
          "

      - name: Activate Theme
        env:
          SLUG: ${{ steps.openai.outputs.slug }}
        run: |
          set -euo pipefail
          ssh -i ~/.ssh/id_rsa_cloudways -o StrictHostKeyChecking=no \
            "$CLOUDWAYS_USER@$CLOUDWAYS_HOST" \
            "cd '$APP_PATH' && wp theme activate '${SLUG}-child' --allow-root || (wp theme list --allow-root; exit 1)"
