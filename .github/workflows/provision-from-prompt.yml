name: Enhanced Child Theme from Prompt

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Describe your website, for example "Modern yoga studio with earth tones and mindfulness focus"'
        required: true
        type: string
      industry:
        description: 'Industry type'
        required: false
        type: choice
        options:
          - 'auto-detect'
          - 'restaurant'
          - 'bakery'
          - 'yoga-studio'
          - 'law-firm'
          - 'photography'
          - 'consulting'
          - 'medical'
          - 'retail'
          - 'real-estate'
          - 'technology'
        default: 'auto-detect'
      generate_images:
        description: 'Generate AI images'
        required: false
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      CLOUDWAYS_HOST: ${{ secrets.CLOUDWAYS_HOST }}
      CLOUDWAYS_USER: ${{ secrets.CLOUDWAYS_USER }}
      CLOUDWAYS_KEY:  ${{ secrets.CLOUDWAYS_KEY }}
      APP_PATH:       ${{ secrets.APP_PATH }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: gsq480/SiteFuse
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      - name: SSH setup
        shell: bash
        run: |
          set -euo pipefail
          echo "[setup] preparing ssh"
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s\n' "$CLOUDWAYS_KEY" > ~/.ssh/id_rsa_cloudways
          chmod 600 ~/.ssh/id_rsa_cloudways
          ssh-keyscan -H "$CLOUDWAYS_HOST" >> ~/.ssh/known_hosts

      - name: AI pass 1 - Enhanced website structure
        shell: bash
        run: |
          set -euo pipefail
          [ -n "${OPENAI_API_KEY:-}" ] || { echo "OPENAI_API_KEY is empty"; exit 1; }
          echo "[ai1] generating comprehensive website structure with enhanced prompt"
          printf '%s' "${{ github.event.inputs.prompt }}"   > /tmp/ai_prompt.txt
          printf '%s' "${{ github.event.inputs.industry }}" > /tmp/ai_industry.txt
          PROMPT="$(cat /tmp/ai_prompt.txt)"
          INDUSTRY="$(cat /tmp/ai_industry.txt)"
          echo "[ai1] Processing prompt: ${PROMPT:0:100}..."
          echo "[ai1] Industry: $INDUSTRY"
          jq -n \
            --arg prompt "$PROMPT" \
            --arg industry "$INDUSTRY" \
            --arg sys 'You are a professional web designer. You MUST return valid JSON in EXACTLY this structure. Do not wrap in arrays. Return a single JSON object with these exact keys: {"slug": "business-name-in-kebab-case", "name": "Exact Business Name", "tagline": "Compelling tagline", "industry": "detected-industry", "colorPalette": {"primary":"#hexcolor","secondary":"#hexcolor","accent":"#hexcolor"}, "typography": {"headingFont":"Google Font Name","bodyFont":"Google Font Name"}, "heroSection": {"customHTML":"<div class=\\"text-center\\"><h1 class=\\"text-5xl md:text-7xl font-bold mb-6 text-white\\">Business Name</h1><p class=\\"text-xl md:text-2xl mb-8 text-gray-100\\">Compelling tagline</p><a href=\\"#contact\\" class=\\"btn btn-primary text-lg px-8 py-4\\">Call to Action</a></div>","heroImage":"https://images.unsplash.com/relevant-photo"}, "customSections": [{"title":"Section Name","html":"<section class=\\"py-16 bg-white\\"><div class=\\"container mx-auto px-4\\"><h2 class=\\"section-title text-center\\">Section Title</h2><p class=\\"text-xl text-gray-600 text-center mb-8\\">Section content</p></div></section>"}] }' \
            --arg usr "Create a complete professional website JSON for: ${PROMPT} Industry context: ${INDUSTRY}" '{ model: "gpt-4o", response_format: {type: "json_object"}, temperature: 0.3, max_tokens: 4000, messages: [{role:"system", content:$sys}, {role:"user", content:$usr}] }' > /tmp/payload.json
          echo "[ai1] calling OpenAI API..."
          HTTP=$(curl -sS -w "\n%{http_code}" "https://api.openai.com/v1/chat/completions" -H "Authorization: Bearer ${OPENAI_API_KEY}" -H "Content-Type: application/json" -d @/tmp/payload.json)
          RESP="$(printf "%s" "$HTTP" | sed '$d')"
          CODE="$(printf "%s" "$HTTP" | tail -n1)"
          printf '%s' "$RESP" > ai1-response.json
          if [ "$CODE" != "200" ]; then
            echo "[ai1] API error code $CODE"
            jq -r '.error.message // "Unknown API error"' ai1-response.json || echo "Failed to parse error"
            exit 1
          fi
          if jq -e '.choices[0].message.content' ai1-response.json >/dev/null 2>&1; then
            echo "[ai1] extracting AI content..."
            jq -r '.choices[0].message.content' ai1-response.json > website-step1.json
            if jq empty website-step1.json; then
              echo "[ai1] JSON valid"
              jq -r '{name:.name,tagline:.tagline,industry:.industry,sectionsCount:(.customSections|length)}' website-step1.json || true
            else
              echo "[ai1] invalid JSON, writing fallback"
              cat > website-step1.json <<'EOJSON'
{
  "slug": "business-site",
  "name": "Your Business",
  "tagline": "Professional services you can trust",
  "industry": "business",
  "colorPalette": {
    "primary": "#2563eb",
    "secondary": "#3b82f6",
    "accent": "#1d4ed8"
  },
  "typography": {
    "headingFont": "Inter",
    "bodyFont": "Inter"
  },
  "heroSection": {
    "customHTML": "<div class=\"text-center\"><h1 class=\"text-5xl md:text-7xl font-bold mb-6 text-white\">Your Business</h1><p class=\"text-xl md:text-2xl mb-8 text-gray-100\">Professional services you can trust</p><a href=\"#contact\" class=\"btn btn-primary text-lg px-8 py-4\">Get Started Today</a></div>",
    "heroImage": "https://images.unsplash.com/photo-1497366216548-37526070297c?w=1200&h=800&fit=crop"
  },
  "customSections": [{
    "title": "About Us",
    "html": "<section class=\"py-16 bg-white\"><div class=\"container mx-auto px-4\"><h2 class=\"section-title text-center\">About Us</h2><p class=\"text-xl text-gray-600 text-center mb-8\">We provide exceptional services to help your business thrive.</p></div></section>"
  }]
}
EOJSON
            fi
          else
            echo "[ai1] no AI content, using fallback"
            cat > website-step1.json <<'EOJSON'
{
  "slug": "business-site",
  "name": "Your Business",
  "tagline": "Professional services you can trust",
  "industry": "business",
  "colorPalette": {
    "primary": "#2563eb",
    "secondary": "#3b82f6",
    "accent": "#1d4ed8"
  },
  "typography": {
    "headingFont": "Inter",
    "bodyFont": "Inter"
  },
  "heroSection": {
    "customHTML": "<div class=\"text-center\"><h1 class=\"text-5xl md:text-7xl font-bold mb-6 text-white\">Your Business</h1><p class=\"text-xl md:text-2xl mb-8 text-gray-100\">Professional services you can trust</p><a href=\"#contact\" class=\"btn btn-primary text-lg px-8 py-4\">Get Started Today</a></div>",
    "heroImage": "https://images.unsplash.com/photo-1497366216548-37526070297c?w=1200&h=800&fit=crop"
  },
  "customSections": [{
    "title": "About Us",
    "html": "<section class=\"py-16 bg-white\"><div class=\"container mx-auto px-4\"><h2 class=\"section-title text-center\">About Us</h2><p class=\"text-xl text-gray-600 text-center mb-8\">We provide exceptional services to help your business thrive.</p></div></section>"
  }]
}
EOJSON
          fi

          rm -f /tmp/ai_prompt.txt /tmp/ai_industry.txt /tmp/payload.json

            .card { background: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 20px 40px rgba(0,0,0,0.08); transition: all 0.3s; }
            .section-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 1rem; color: var(--color-dark); }
            .hero-section { position: relative; min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(0,0,0,0.4), rgba(0,0,0,0.6)); }
