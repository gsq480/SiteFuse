name: Enhanced Child Theme from Prompt

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Describe your website, for example "Modern yoga studio with earth tones and mindfulness focus"'
        required: true
        type: string
      industry:
        description: 'Industry type'
        required: false
        type: choice
        options:
          - 'auto-detect'
          - 'restaurant'
          - 'bakery'
          - 'yoga-studio'
          - 'law-firm'
          - 'photography'
          - 'consulting'
          - 'medical'
          - 'retail'
          - 'real-estate'
          - 'technology'
        default: 'auto-detect'
      generate_images:
        description: 'Generate AI images'
        required: false
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      CLOUDWAYS_HOST: ${{ secrets.CLOUDWAYS_HOST }}
      CLOUDWAYS_USER: ${{ secrets.CLOUDWAYS_USER }}
      CLOUDWAYS_KEY:  ${{ secrets.CLOUDWAYS_KEY }}
      APP_PATH:       ${{ secrets.APP_PATH }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: gsq480/SiteFuse
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      - name: SSH setup
        run: |
          set -euo pipefail
          echo "[setup] preparing ssh"
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s\n' "$CLOUDWAYS_KEY" > ~/.ssh/id_rsa_cloudways
          chmod 600 ~/.ssh/id_rsa_cloudways
          ssh-keyscan -H "$CLOUDWAYS_HOST" >> ~/.ssh/known_hosts

      - name: AI pass 1 - Enhanced website structure
        run: |
          set -euo pipefail
          echo "[ai1] creating Rise & Grind bakery content"
          
          cat > website-step1.json << 'JSON_EOF'
          {
            "slug": "rise-and-grind",
            "name": "Rise & Grind",
            "tagline": "Fresh artisanal bread and coffee daily",
            "industry": "bakery",
            "colorPalette": {
              "primary": "#8B4513",
              "secondary": "#CC5500",
              "accent": "#F5F1EB"
            },
            "typography": {
              "headingFont": "Playfair Display",
              "bodyFont": "Lato"
            },
            "heroSection": {
              "customHTML": "<div class='text-center'><h1 class='text-5xl md:text-7xl font-bold mb-6 text-white'>Rise & Grind</h1><p class='text-xl md:text-2xl mb-8 text-gray-100'>Fresh artisanal bread and coffee daily in Canberra</p><a href='#contact' class='btn btn-primary text-lg px-8 py-4'>Order Online</a></div>",
              "heroImage": "https://images.unsplash.com/photo-1509440159596-0249088772ff?w=1200&h=800&fit=crop"
            },
            "customSections": [
              {
                "title": "Featured Pastries",
                "html": "<section class='py-16 bg-white'><div class='container mx-auto px-4'><h2 class='section-title text-center'>Daily Fresh Pastries</h2><p class='text-xl text-gray-600 text-center mb-8'>Handcrafted daily using traditional techniques</p></div></section>"
              }
            ]
          }
          JSON_EOF
          
          echo "[ai1] âœ… Created bakery content"          jq -n '{
            slug: "rise-and-grind",
            name: "Rise & Grind",
            tagline: "Fresh artisanal bread and coffee daily",
            industry: "bakery",
            colorPalette: {
              primary: "#8B4513",
              secondary: "#CC5500",
              accent: "#F5F1EB"
            },
            typography: {
              headingFont: "Playfair Display",
              bodyFont: "Lato"
            },
            heroSection: {
              "customHTML": "<div class='text-center'><h1 class='text-5xl md:text-7xl font-bold mb-6 text-white'>Rise & Grind</h1><p class='text-xl md:text-2xl mb-8 text-gray-100'>Fresh artisanal bread and coffee daily in Canberra</p><a href='#contact' class='btn btn-primary text-lg px-8 py-4'>Order Online</a></div>",
              "heroImage": "https://images.unsplash.com/photo-1509440159596-0249088772ff?w=1200&h=800&fit=crop"
            },
            "customSections": [
              {
                "title": "Featured Pastries",
                "html": "<section class='py-16 bg-white'><div class='container mx-auto px-4'><h2 class='section-title text-center'>Daily Fresh Pastries</h2><p class='text-xl text-gray-600 text-center mb-8'>Handcrafted daily using traditional techniques</p></div></section>"
              }
            ]
          }' > website-step1.json